---
layout:     post
title:      初试FreeRTOS
subtitle:   学习和错误记录
date:       2018-9-14
author:     Reo
header-img: img/post-bg-rwd.jpg
catalog:     true
tags:
    - 嵌入式
    - freertos
    
---

#1. 前言

----------

>FreeRTOS是一个迷你的实时操作系统内核。作为一个轻量级的操作系统，功能包括：任务管理、时间管理、信号量、消息队列、内存管理、记录功能、软件定时器、协程等，可基本满足较小系统的需要。
>去年年底亚马逊收购了FreeRTOS，公司的SDK也全换成了Amazon-FreeRTOS。由于Amazon-FreeRTOS是在FreeRTOS基础上提升安全等模块升级，所以决定还是从基础的FreeRTOS开始学习，毕竟FreeRTOS已经广泛应用10年左右了。
    [FreeRTOS官网][1]
    [Github of Amazon-FreeRTOS][2]
  

#2. 准备


----------


 - Platform

    开发板就选顺手的FRDMKL27Z，由于FreeRTOS的demo中都是LPC开发板，手头没有，所以只能移植。好在FRDMKL27Z的SDK中有Amazon-FreeRTOS example，在移植过程中可以参考。

 - IDE
    IDE当然是用IAR了，大学期间一直使用的MDK，刚开始使用IAR真的不习惯。但是熟悉IAR后发现真的不想用MDK了。

 - Driver
    在freertos官网下载最新的FreeRTOSv10.1.1，主要文件为include文件夹，list.c， queue.c， tasks.c 和portable中对应开发平台适配文件。FRDMKL27Z的SDK2.0一份，参考demo创建一个IAR project。然后添加一个group freertos.由于FRDMKL27Z是M0核的，所以portable中只要添加ARM_CM0和MemMang文件夹下的文件就可以了。工程中freertos group文件结构如下图：
![文件结构][3]
然后还要添加各个头文件路径：
![添加引用路径][4]

#3.测试


----------


 首先需要添加一个freertos的本地配置文件*FreeRTOSConfig.h*，这个config file会根据平台和程序要求更改，我直接参考的SDK中demo的配置：
 

    #ifndef FREERTOS_CONFIG_H
    #define FREERTOS_CONFIG_H
    #define configUSE_PREEMPTION                    1
    #define configUSE_TICKLESS_IDLE                 0
    #define configCPU_CLOCK_HZ                      (8000000u)
    #define configTICK_RATE_HZ                      ((TickType_t)200)
    #define configMAX_PRIORITIES                    5
    #define configMINIMAL_STACK_SIZE                ((unsigned short)90)
    #define configMAX_TASK_NAME_LEN                 20
    #define configUSE_16_BIT_TICKS                  0
    #define configIDLE_SHOULD_YIELD                 1
    #define configUSE_TASK_NOTIFICATIONS            1
    #define configUSE_MUTEXES                       1
    #define configUSE_RECURSIVE_MUTEXES             1
    #define configUSE_COUNTING_SEMAPHORES           1
    #define configUSE_ALTERNATIVE_API               0 /* Deprecated! */
    #define configQUEUE_REGISTRY_SIZE               8
    #define configUSE_QUEUE_SETS                    0
    #define configUSE_TIME_SLICING                  0
    #define configUSE_NEWLIB_REENTRANT              0
    #define configENABLE_BACKWARD_COMPATIBILITY     0
    #define configNUM_THREAD_LOCAL_STORAGE_POINTERS 5
    /* Used memory allocation (heap_x.c) */
    #define configFRTOS_MEMORY_SCHEME               4
    #define configINCLUDE_FREERTOS_TASK_C_ADDITIONS_H 0
    /* Memory allocation related definitions. */
    #define configSUPPORT_STATIC_ALLOCATION         0
    #define configSUPPORT_DYNAMIC_ALLOCATION        1
    #define configTOTAL_HEAP_SIZE                   ((size_t)(10 * 1024))
    #define configAPPLICATION_ALLOCATED_HEAP        0
    /* Hook function related definitions. */
    #define configUSE_IDLE_HOOK                     0
    #define configUSE_TICK_HOOK                     0
    #define configCHECK_FOR_STACK_OVERFLOW          0
    #define configUSE_MALLOC_FAILED_HOOK            0
    #define configUSE_DAEMON_TASK_STARTUP_HOOK      0
    /* Run time and task stats gathering related definitions. */
    #define configGENERATE_RUN_TIME_STATS           0
    #define configUSE_TRACE_FACILITY                1
    #define configUSE_STATS_FORMATTING_FUNCTIONS    0
    /* Task aware debugging. */
    #define configRECORD_STACK_HIGH_ADDRESS         1
    /* Co-routine related definitions. */
    #define configUSE_CO_ROUTINES                   0
    #define configMAX_CO_ROUTINE_PRIORITIES         2
    /* Software timer related definitions. */
    #define configUSE_TIMERS                        1
    #define configTIMER_TASK_PRIORITY               (configMAX_PRIORITIES - 1)
    #define configTIMER_QUEUE_LENGTH                10
    #define configTIMER_TASK_STACK_DEPTH            (configMINIMAL_STACK_SIZE * 2)
    /* Define to trap errors during development. */
    #define configASSERT(x) if(( x) == 0) {taskDISABLE_INTERRUPTS(); for (;;);}
    /* Optional functions - most linkers will remove unused functions anyway. */
    #define INCLUDE_vTaskPrioritySet                1
    #define INCLUDE_uxTaskPriorityGet               1
    #define INCLUDE_vTaskDelete                     1
    #define INCLUDE_vTaskSuspend                    1
    #define INCLUDE_vTaskDelayUntil                 1
    #define INCLUDE_vTaskDelay                      1
    #define INCLUDE_xTaskGetSchedulerState          1
    #define INCLUDE_xTaskGetCurrentTaskHandle       1
    #define INCLUDE_uxTaskGetStackHighWaterMark     0
    #define INCLUDE_xTaskGetIdleTaskHandle          0
    #define INCLUDE_eTaskGetState                   0
    #define INCLUDE_xTimerPendFunctionCall          1
    #define INCLUDE_xTaskAbortDelay                 0
    #define INCLUDE_xTaskGetHandle                  0
    #define INCLUDE_xTaskResumeFromISR              1
    /* Definitions that map the FreeRTOS port interrupt handlers to their CMSIS
    standard names. */
    #define vPortSVCHandler SVC_Handler
    #define xPortPendSVHandler PendSV_Handler
    #define xPortSysTickHandler SysTick_Handler
    #endif /* FREERTOS_CONFIG_H */

然后编写测试程序main.c

    /* FreeRTOS kernel includes. */
    #include "FreeRTOS.h"
    #include "task.h"
    #include "queue.h"
    #include "timers.h"
    /* Freescale includes. */
    #include "fsl_device_registers.h"
    #include "fsl_debug_console.h"
    #include "board.h"
    #include "pin_mux.h"
    #include "clock_config.h"
    void vTask(void *pvParameters);
    int main()
    {
        BOARD_InitPins();
        BOARD_BootClockRUN();
        BOARD_InitDebugConsole();
        PRINTF("Board Start!\r\n");
        xTaskCreate(vTask,"Task1",configMINIMAL_STACK_SIZE + 20,NULL,3,NULL);
        vTaskStartScheduler();
        while(1);
    }
    void vTask(void *pvParameters)
    {
        while(1)
        {
            PRINTF("1s \r\n");
            vTaskDelay(1000);
        }
    }
  最后编译下载，串口打印一个Board Start!后每秒打印一个1s，移植成功。
  
#4.问题


----------

 - 汇编文件引用问题
 在freertos中的portable有个`portasm.s`汇编文件，类似startup，但是它会调用头文件`#include <FreeRTOSConfig.h>`。在编译时一直报错不能打开`FreeRTOSConfig.h`，我好奇我明明添加了`FreeRTOSConfig.h`的路径为什么还会报错。后来查询才得知IAR中汇编文件的引用路径要单独添加，如图：
![汇编引用][5]
 - 内存溢出
 在我没有添加freertos任务时程序编译运行正常，但是添加了task后编译就报错内存溢出。通过网上查询后才发现Linker ICF file用的IAR默认的，后来改为driver中的MKL27Z64xxx4_flash.icf就完美解决了。
![此处输入图片的描述][6]


  [1]: https://www.freertos.org/ "FreeRTOS官网"
  [2]: https://github.com/aws/amazon-freertos "Github of Amazon-FreeRTOS"
  [3]: http://p6wf2jj0b.bkt.clouddn.com/freertos_file.PNG
  [4]: http://p6wf2jj0b.bkt.clouddn.com/Cprepro.PNG
  [5]: http://p6wf2jj0b.bkt.clouddn.com/Aprepro.PNG
  [6]: http://p6wf2jj0b.bkt.clouddn.com/flash_icf.PNG